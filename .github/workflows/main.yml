name: Run Luma Selenium Tests

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  selenium-tests:
    runs-on: ubuntu-latest

    services:
      selenium:
        image: selenium/standalone-chrome:latest
        ports:
          - 4444:4444
        options: >-
          --shm-size=2g

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Java
      uses: actions/setup-java@v3
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Build Docker image
      run: docker build -t luma-tests .

    - name: Run tests in Docker container
      run: docker run --network host luma-tests
      continue-on-error: true

    - name: Set job status
      if: ${{ failure() }}
      run: echo "STATUS=FAILURE" >> $GITHUB_ENV

    - name: Set job status
      if: ${{ success() }}
      run: echo "STATUS=SUCCESS" >> $GITHUB_ENV

    - name: Send Email Notification
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.gmail.com
        server_port: 465
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: 'Luma Test Results: ${{ env.STATUS }}'
        to: ${{ secrets.EMAIL_RECIPIENT }}
        from: ${{ secrets.EMAIL_USERNAME }}
        content_type: text/plain
        body: |
          Hello,

          The Selenium test run has completed.
          Status: ${{ env.STATUS }}

          Regards,
          Luma CI Bot
